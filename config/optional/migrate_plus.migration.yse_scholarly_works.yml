id: yse_scholarly_works
label: 'YSE Scholarly Works Import'
migration_group: yse_scholarly_works

# Dependencies on contrib modules
dependencies:
  enforced:
    module:
      - migrate_plus
      - migrate_conditions

source:
  plugin: url
  data_fetcher_plugin: file
  data_parser_plugin: ndjson
  urls:
    - 'public://migrations/allscholarlyworksrecords.ndjson'
  # For NDJSON, each line is a complete item, so item_selector is not needed
  # item_selector: '/' # Or leave empty for root-level items
  ids:
    id:
      type: string
  fields:
    - name: id
      label: Work OpenAlex ID
      selector: id
    - name: ids
      label: All work identifiers (object)
      selector: ids
    - name: doi
      label: DOI
      selector: doi
    - name: type
      label: Work type
      selector: type
    - name: title
      label: Work text title
      selector: title
    - name: display_name
      label: Work title
      selector: display_name
    - name: authorships
      label: Author array
      selector: authorships
    - name: raw_names_first
      label: First author name
      selector: raw_names_first
    - name: raw_names_middle
      label: Middle author names
      selector: raw_names_middle
    - name: raw_names_last
      label: Last author name
      selector: raw_names_last
    - name: biblio
      label: Bibliographic info (object)
      selector: biblio
    - name: primary_location
      label: Primary location (object)
      selector: primary_location
    - name: open_access
      label: Open access (object)
      selector: open_access
    - name: publication_date
      label: Publication date string
      selector: publication_date
    - name: publication_year
      label: Publication year
      selector: publication_year
    - name: sustainable_development_goals
      label: SDG array
      selector: sustainable_development_goals
    - name: created_date
      label: Repository created date
      selector: created_date
    - name: updated_date
      label: Repository updated date
      selector: updated_date
    - name: abstract_assembled
      label: Abstract text
      selector: abstract_assembled

process:
  # === Node Title and Basic Fields ===
  # Truncate title to 255 chars and use display_name as fallback if title is empty
  title:
    -
      plugin: if_condition
      source: title
      condition: empty
      else_get: title
      then_get: display_name
    -
      plugin: substr
      length: 255
    -
      plugin: skip_on_empty
      method: process

  # === Typed Identifier Transformations ===
  field_work_typed_ids:
    plugin: to_typed_identifier
    source: ids
    is_nested: false
    exclude_keys:
      - mag
    check_field_settings: true
    use_generic_fallback: true
    destination_field: field_work_typed_ids

  field_authors_typed_ids:
    plugin: to_typed_identifier
    source: authorships
    is_nested: true
    exclude_keys:
      - display_name
      - author_position
    check_field_settings: true
    use_generic_fallback: true
    destination_field: field_authors_typed_ids

  # === Simple Field Mappings ===
  field_doi: doi
  field_raw_type: type
  field_work_display_name/value: display_name
  field_work_display_name/format:
    plugin: default_value
    default_value: basic_html

  # === Nested Field Extraction ===
  # Publication venue coalesce using if_condition:
  # Primary: raw_source_name (~761 records with values)
  # Fallback: source/display_name (768 records have it)
  # Total: ~814 records should have at least one value
  field_source_display_name:
    plugin: if_condition
    source: primary_location/raw_source_name
    condition: not:empty
    else_get: primary_location/source/display_name

  field_license:
    plugin: get
    source: primary_location/license

  field_primary_url:
    plugin: get
    source: primary_location/landing_page_url

  # === Author Names ===
  field_raw_names_first: raw_names_first
  field_raw_names_middle: raw_names_middle
  field_raw_names_last: raw_names_last

  # === Publication Details ===
  field_publication_date_string: publication_date
  field_publication_year_string:
    plugin: callback
    callable: strval
    source: publication_year

  field_publication_year_digits: publication_year

  field_publication_date_object:
    plugin: format_date
    source: publication_date
    from_format: 'Y-m-d'
    to_format: 'Y-m-d'
    from_timezone: 'UTC'
    to_timezone: 'UTC'

  # === Bibliographic Information ===
  field_biblio_volume:
    plugin: get
    source: biblio/volume

  field_biblio_issue:
    plugin: get
    source: biblio/issue

  field_biblio_page_first:
    plugin: get
    source: biblio/first_page

  field_biblio_page_last:
    plugin: get
    source: biblio/last_page

  # === Open Access Status ===
  field_raw_oa_status:
    plugin: get
    source: open_access/oa_status

  # === Abstract Fields ===

  field_abstract_text_index:
    -
      plugin: sub_process
      source:
        - abstract_assembled
      process:
        value: abstract_assembled
        format:
          plugin: default_value
          default_value: full_html
  field_abstract_text_display:
    -
      plugin: skip_on_condition
      method: process
      condition:
        plugin: not:in_array
        value: '@primary_location/license'
        array:
          - cc-by
          - cc-by-nc
          - cc-by-nc-sa
          - cc-by-sa
          - public-domain
    -
      plugin: sub_process
      source:
        - abstract_assembled
      process:
        value: abstract_assembled
        format:
          plugin: default_value
          default_value: full_html

  # === Date Fields (ISO 8601 Parsing) ===
  # created_date: "2025-10-10T00:00:00" - already in correct format
  # updated_date: "2025-10-27T03:07:04.448195" - has microseconds
  field_repo_created_date:
    -
      plugin: get
      source: created_date
    -
      plugin: format_date
      from_format: 'Y-m-d\TH:i:s'
      to_format: 'Y-m-d'
      from_timezone: 'UTC'
      to_timezone: 'UTC'

  # For updated_date, parse with microseconds and output without
  field_repo_updated_date:
    -
      plugin: get
      source: updated_date
    -
      plugin: format_date
      from_format: 'Y-m-d\TH:i:s.u'
      to_format: 'Y-m-d'
      from_timezone: 'UTC'
      to_timezone: 'UTC'

  # === Sustainable Development Goals ===
  # Extract numeric SDG ID from URL: https://metadata.un.org/sdg/10 -> 10
  # Using basename() to get the last path segment (e.g., '10' from URL ending)
  field_raw_sdgs:
    plugin: sub_process
    source: sustainable_development_goals
    process:
      value:
        -
          plugin: get
          source: id
        -
          plugin: skip_on_empty
          method: process
        -
          plugin: callback
          callable: 'basename'

destination:
  plugin: entity:node
  default_bundle: scholarly_work

migration_dependencies:
  required: []
  optional: []
